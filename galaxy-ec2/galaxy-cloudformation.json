{
    "AWSTemplateFormatVersion" : "2010-09-09",
    "Parameters" : {
        "Environment": {
            "Description" : "Unique name of this Galaxy environment within your EC2 account",
            "Type": "String",
            "AllowedPattern": "[a-z0-9][_a-z0-9]*"
        },
        "CoordinatorInstanceType" : {
            "Description" : "EC2 instance type of the coordinator",
            "Default" : "t1.micro",
            "Type" : "String"
        },
        "DefaultAgentInstanceType" : {
            "Description" : "Default EC2 instance type for agents",
            "Default" : "t1.micro",
            "Type" : "String"
        },
        "SecurityGroup": {
            "Description" : "EC2 security group for coordinator and agents",
            "Type": "String",
            "Default": "default"
        },
        "KeyName" : {
            "Description" : "Name of and existing EC2 KeyPair to enable SSH access to the instances",
            "Type" : "String",
            "Default": "keypair"
        },
        "CoordinatorPort": {
            "Description" : "Bind port for coordinator",
            "Type": "Number",
            "Default": "64000",
            "MinValue": "1",
            "MaxValue": "65535"
        },
        "BinaryRepoURI": {
            "Description" : "Urls of the binary repositories (comma-separated)",
            "Type": "String",
            "Default": "https://oss.sonatype.org/content/repositories/releases/,https://oss.sonatype.org/content/repositories/snapshots"
        },
        "ConfigGitRepoURI": {
            "Description" : "Git url of the configuration repository",
            "Type": "String",
            "Default": "git://github.com/dain/galaxy-example-config.git"
        },
        "GalaxyVersion": {
            "Description" : "Version of Galaxy to use",
            "Type": "String",
            "Default": "0.8-SNAPSHOT"
        }
    },
    "Resources" : {
        "CoordinatorUser": {
            "Type" : "AWS::IAM::User",
            "Properties": {
                "Policies": [
                    {
                        "PolicyName": "accessPermissions",
                        "PolicyDocument": {
                            "Statement": [{
                                "Sid": "Stmt1318024300306",
                                    "Action": [
                                        "ec2:CreateTags",
                                        "ec2:DeleteTags",
                                        "ec2:DescribeAvailabilityZones",
                                        "ec2:DescribeInstances",
                                        "ec2:RunInstances",
                                        "ec2:StartInstances",
                                        "ec2:StopInstances",
                                        "ec2:TerminateInstances"
                                    ],
                                    "Effect": "Allow",
                                    "Resource": "*"
                                },
                                {
                                    "Sid": "Stmt1319926760042",
                                    "Action": [
                                        "sdb:CreateDomain",
                                        "sdb:PutAttributes",
                                        "sdb:BatchDeleteAttributes",
                                        "sdb:DeleteAttributes",
                                        "sdb:Select"
                                    ],
                                    "Effect": "Allow",
                                    "Resource" : { "Fn::Join": ["", ["arn:aws:sdb:*:*:domain/galaxy-", { "Ref": "Environment" }]] }
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "CoordinatorAccessKey" : {
            "Type" : "AWS::IAM::AccessKey",
            "Properties": {
                "UserName": { "Ref": "CoordinatorUser" }
            }
        },
        "CoordinatorInstance" : {
            "Type" : "AWS::EC2::Instance",
            "Properties" : {
                "ImageId" : "ami-27b7744e",
                "InstanceType" : {
                    "Ref" : "CoordinatorInstanceType"
                },
                "SecurityGroups" : [
                    {
                        "Ref": "SecurityGroup"
                    }
                ],
                "KeyName" : {
                    "Ref" : "KeyName"
                },
                "Tags" : [
                    {
                        "Key" : "Name",
                        "Value" : { "Fn::Join": ["-", ["galaxy", { "Ref": "Environment" }, "coordinator"]] }
                    }
                ],
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": ["\n",
                                     [
                                             "Content-Type: multipart/mixed; boundary=\"===============4809107299230207060==\"",
                                             "MIME-Version: 1.0",
                                             "",
                                             "--===============4809107299230207060==",
                                             "Content-Type: text/x-include-url; charset=\"us-ascii\"",
                                             "MIME-Version: 1.0",
                                             "Content-Transfer-Encoding: 7bit",
                                             "Content-Disposition: attachment; filename=\"galaxy-part-handler.py\"",
                                             "",
                                             {
                                                 "Fn::Join": ["/", [
                                                     "http://s3.amazonaws.com/galaxy-cloud-formation",
                                                     { "Ref": "GalaxyVersion" },
                                                     "galaxy-part-handler.py"
                                                 ]]
                                             },
                                             "",
                                             "--===============4809107299230207060==",
                                             "Content-Type: text/plain; charset=\"us-ascii\"",
                                             "MIME-Version: 1.0",
                                             "Content-Transfer-Encoding: 7bit",
                                             "Content-Disposition: attachment; filename=\"installer.properties\"",
                                             "",
                                             {
                                                 "Fn::Join": ["=", ["galaxy.version", { "Ref": "GalaxyVersion" }]]
                                             },
                                             {
                                                 "Fn::Join": ["=", ["environment", { "Ref": "Environment" }]]
                                             },
                                             {
                                                 "Fn::Join": ["=", ["artifacts", "galaxy-coordinator,galaxy-configuration-repository"]]
                                             },
                                             "",
                                             "--===============4809107299230207060==",
                                             "Content-Type: text/plain; charset=\"us-ascii\"",
                                             "MIME-Version: 1.0",
                                             "Content-Transfer-Encoding: 7bit",
                                             "Content-Disposition: attachment; filename=\"galaxy-coordinator.properties\"",
                                             "",
                                             {
                                                 "Fn::Join": ["=", ["galaxy.version", { "Ref": "GalaxyVersion" }]]
                                             },
                                             {
                                                 "Fn::Join": ["=", ["http-server.http.port", { "Ref": "CoordinatorPort" }]]
                                             },
                                             {
                                                 "Fn::Join": ["=", ["coordinator.binary-repo", { "Ref": "BinaryRepoURI" }]]
                                             },
                                             {
                                                 "Fn::Join": ["=", ["coordinator.provisioner", "aws"]]
                                             },
                                             {
                                                 "Fn::Join": ["=", ["coordinator.aws.access-key", {"Ref" : "CoordinatorAccessKey"} ]]
                                             },
                                             {
                                                 "Fn::Join": ["=", ["coordinator.aws.secret-key", {"Fn::GetAtt" : ["CoordinatorAccessKey", "SecretAccessKey"]} ]]
                                             },
                                             {
                                                 "Fn::Join": ["=", ["coordinator.aws.agent.ami", "ami-27b7744e"]]
                                             },
                                             {
                                                 "Fn::Join": ["=", ["coordinator.aws.agent.keypair", { "Ref": "KeyName" }]]
                                             },
                                             {
                                                 "Fn::Join": ["=", ["coordinator.aws.agent.security-group", { "Ref": "SecurityGroup" }]]
                                             },
                                             {
                                                 "Fn::Join": ["=", ["coordinator.aws.agent.default-instance-type", { "Ref": "DefaultAgentInstanceType" }]]
                                             },
                                             "",
                                             "--===============4809107299230207060==",
                                             "Content-Type: text/plain; charset=\"us-ascii\"",
                                             "MIME-Version: 1.0",
                                             "Content-Transfer-Encoding: 7bit",
                                             "Content-Disposition: attachment; filename=\"galaxy-configuration-repository.properties\"",
                                             "",
                                             {
                                                 "Fn::Join": ["=", ["configuration-repository.git.uri", { "Ref": "ConfigGitRepoURI" }]]
                                             },
                                             "",
                                             "--===============4809107299230207060==",
                                             "Content-Type: text/x-include-url; charset=\"us-ascii\"",
                                             "MIME-Version: 1.0",
                                             "Content-Transfer-Encoding: 7bit",
                                             "Content-Disposition: attachment; filename=\"galaxy-install.rb\"",
                                             "",
                                             {
                                                 "Fn::Join": ["/", [
                                                     "http://s3.amazonaws.com/galaxy-cloud-formation",
                                                     { "Ref": "GalaxyVersion" },
                                                     "galaxy-install.rb"
                                                 ]]
                                             },
                                             "",
                                             "--===============4809107299230207060=="
                                     ]
                        ]
                    }
                }
            }
        }
    },
    "Outputs" : {
        "Coordinator" : {
            "Value" : {
                "Fn::GetAtt" : [ "CoordinatorInstance" , "PublicDnsName" ]
            }
        },
        "CoordinatorURL" : {
            "Value" : {
                "Fn::Join" : [ "", [ "http://", { "Fn::GetAtt" : [ "CoordinatorInstance" , "PublicIp" ] }, ":", { "Ref" : "CoordinatorPort" }]]
            }
        }
    }
}
